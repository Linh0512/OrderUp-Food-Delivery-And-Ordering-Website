<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${isNew ? 'Thêm nhà hàng mới' : 'Chỉnh sửa nhà hàng'}">Quản lý Nhà hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-section-title {
            margin-bottom: 15px;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 th:text="${isNew ? 'Thêm nhà hàng mới' : 'Chỉnh sửa nhà hàng'}">Quản lý nhà hàng</h1>
            <a href="/admin/restaurants" class="btn btn-secondary">Quay lại danh sách</a>
        </div>
        
        <form th:action="${isNew ? '/admin/restaurants/create' : '/admin/restaurants/' + restaurant.id + '/edit'}" 
              method="post" 
              th:object="${restaurant}" 
              class="needs-validation" 
              id="restaurantForm"
              novalidate>
            
            <!-- ID Hidden -->
            <input type="hidden" th:field="*{id}" />
            
            <!-- Section: Thông tin cơ bản -->
            <div class="form-section">
                <h3 class="form-section-title">Thông tin cơ bản</h3>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">Tên nhà hàng <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" th:field="*{basicInfo.name}" required>
                        <div class="invalid-feedback">Vui lòng nhập tên nhà hàng</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="phone" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="phone" th:field="*{basicInfo.phone}" required>
                        <div class="invalid-feedback">Vui lòng nhập số điện thoại hợp lệ</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" th:field="*{basicInfo.email}" required>
                        <div class="invalid-feedback">Vui lòng nhập email hợp lệ</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="website" class="form-label">Website</label>
                        <input type="url" class="form-control" id="website" th:field="*{basicInfo.website}">
                        <div class="invalid-feedback">Vui lòng nhập URL hợp lệ (bao gồm http:// hoặc https://)</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Mô tả</label>
                    <textarea class="form-control" id="description" rows="3" th:field="*{basicInfo.description}"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="images" class="form-label">Ảnh (phân cách bằng dấu phẩy)</label>
                    <input type="text" class="form-control" id="images" 
                           th:value="${restaurant.basicInfo != null && restaurant.basicInfo.images != null ? #strings.arrayJoin(restaurant.basicInfo.images, ',') : ''}">
                    <div class="form-text">Nhập URL hình ảnh, phân cách nhiều ảnh bằng dấu phẩy</div>
                </div>
                
                <div class="mb-3">
                    <label for="categories" class="form-label">Danh mục (phân cách bằng dấu phẩy)</label>
                    <input type="text" class="form-control" id="categories" 
                           th:value="${restaurant.tags != null ? #strings.arrayJoin(restaurant.tags, ',') : ''}">
                    <div class="form-text">Ví dụ: Nhà hàng, Quán ăn, Đồ Á, Đồ Âu</div>
                </div>
            </div>
            
            <!-- Section: Địa chỉ -->
            <div class="form-section">
                <h3 class="form-section-title">Địa chỉ</h3>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="fullAddress" class="form-label">Địa chỉ đầy đủ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fullAddress" th:field="*{address.fullAddress}" required>
                        <div class="invalid-feedback">Vui lòng nhập địa chỉ</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="district" class="form-label">Quận/Huyện <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="district" th:field="*{address.district}" required>
                        <div class="invalid-feedback">Vui lòng nhập quận/huyện</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="city" class="form-label">Thành phố <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="city" th:field="*{address.city}" required>
                        <div class="invalid-feedback">Vui lòng nhập thành phố</div>
                    </div>
                </div>
            </div>
            
            <!-- Section: Thời gian hoạt động -->
            <div class="form-section">
                <h3 class="form-section-title">Thời gian hoạt động</h3>
                
                <div class="row">
                    <div class="col-md-3"><strong>Ngày</strong></div>
                    <div class="col-md-3"><strong>Giờ mở cửa</strong></div>
                    <div class="col-md-3"><strong>Giờ đóng cửa</strong></div>
                    <div class="col-md-3"><strong>Trạng thái</strong></div>
                </div>
                                
                <div class="row mb-3" th:each="dayName, iterStat : ${daysOfWeek}"></div>
                    <div class="col-md-3">
                        <label th:text="${dayName}">Ngày</label>
                    </div>
                    <div class="col-md-3">
                        <input type="time" class="form-control" th:name="|operatingHours[${iterStat.index}].openTime|" value="09:00">
                    </div>
                    <div class="col-md-3">
                        <input type="time" class="form-control" th:name="|operatingHours[${iterStat.index}].closeTime|" value="22:00">
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" th:id="|isOpen_${iterStat.index}|" 
                                th:name="|operatingHours[${iterStat.index}].isOpen|" checked>
                            <label class="form-check-label" th:for="|isOpen_${iterStat.index}|">Mở cửa</label>
                        </div>
                        <input type="hidden" th:name="|operatingHours[${iterStat.index}].dayOfWeek|" th:value="${iterStat.index}">
                    </div>
                </div>
            </div>
            
            <!-- Section: Trạng thái -->
            <div class="form-section">
                <h3 class="form-section-title">Trạng thái</h3>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="active" th:field="*{active}">
                        <label class="form-check-label" for="active">Đang hoạt động</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="featured" th:field="*{featured}">
                        <label class="form-check-label" for="featured">Nhà hàng nổi bật</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="verificationStatus" class="form-label">Trạng thái xác minh</label>
                    <select class="form-select" id="verificationStatus" th:field="*{verificationStatus}">
                        <option value="pending">Đang chờ duyệt</option>
                        <option value="approved">Đã duyệt</option>
                        <option value="rejected">Từ chối</option>
                    </select>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="/admin/restaurants" class="btn btn-secondary me-md-2">Hủy</a>
                <button type="submit" class="btn btn-primary">Lưu thông tin</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form validation
            const form = document.getElementById('restaurantForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (!form.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    
                    // Process images array
                    const imagesList = document.getElementById('images').value;
                    if (imagesList) {
                        const images = imagesList.split(',').map(img => img.trim()).filter(img => img);
                        
                        // Remove any existing hidden inputs for images
                        const existingImageInputs = form.querySelectorAll('input[name^="basicInfo.images["]');
                        existingImageInputs.forEach(input => input.remove());
                        
                        // Add new hidden inputs
                        images.forEach((img, index) => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'basicInfo.images[' + index + ']';
                            input.value = img;
                            form.appendChild(input);
                        });
                    }
                    
                    // Process categories array
                    const categoriesList = document.getElementById('categories').value;
                    if (categoriesList) {
                        const categories = categoriesList.split(',').map(cat => cat.trim()).filter(cat => cat);
                        
                        // Remove any existing hidden inputs for categories
                        const existingCategoryInputs = form.querySelectorAll('input[name^="tags["]');
                        existingCategoryInputs.forEach(input => input.remove());
                        
                        // Add new hidden inputs
                        categories.forEach((cat, index) => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'tags[' + index + ']';
                            input.value = cat;
                            form.appendChild(input);
                        });
                    }
                    
                    form.classList.add('was-validated');
                });
            }
            
            // Toggle time inputs based on isOpen checkbox
            const openCheckboxes = document.querySelectorAll('input[id^="isOpen_"]');
            openCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const index = this.id.replace('isOpen_', '');
                    const timeInputs = document.querySelectorAll(`input[name^="operatingHours[${index}]"][type="time"]`);
                    
                    timeInputs.forEach(input => {
                        input.disabled = !this.checked;
                        if (!this.checked) {
                            input.classList.add('text-muted');
                        } else {
                            input.classList.remove('text-muted');
                        }
                    });
                });
                
                // Initialize state
                checkbox.dispatchEvent(new Event('change'));
            });
        });
        </script>
</body>
</html>